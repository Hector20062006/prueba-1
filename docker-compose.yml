services:
  # Servicio 1: El servidor Web (Apache)
  web:
    image: httpd:2.4-alpine
    ports:
      - "8080:80"
    volumes:
      # Montamos tu código en el servidor web para que pueda servir CSS e imágenes
      - ./:/var/www/html/
      # Montamos la configuración personalizada de Apache
      - ./docker/apache/hospital.conf:/usr/local/apache2/conf/extra/hospital.conf
    # Comandos para activar módulos necesarios (Proxy y FCGI) al iniciar
    command: >
      /bin/sh -c "sed -i 's/#LoadModule proxy_module/LoadModule proxy_module/' /usr/local/apache2/conf/httpd.conf &&
      sed -i 's/#LoadModule proxy_fcgi_module/LoadModule proxy_fcgi_module/' /usr/local/apache2/conf/httpd.conf &&
      sed -i 's/#LoadModule rewrite_module/LoadModule rewrite_module/' /usr/local/apache2/conf/httpd.conf &&
      echo 'Include conf/extra/hospital.conf' >> /usr/local/apache2/conf/httpd.conf &&
      httpd-foreground"
    depends_on:
      - php

  # Servicio 2: El intérprete de PHP (FPM)
  php:
    build:
      context: ./docker/php
      dockerfile: Dockerfile
    volumes:
      # PHP también necesita ver tus archivos para ejecutarlos
      - ./:/var/www/html/
    depends_on:
      - db

  # Servicio 3: Base de Datos (MySQL)
  db:
    image: mariadb:10.6  # Mucho mejor rendimiento en Raspberry Pi
    container_name: hospital_db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: hospital_db
      MYSQL_USER: usuario_hospital
      MYSQL_PASSWORD: password123
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql

volumes:
  db_data: